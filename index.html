<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>EventHub - Optimized Platform</title>
    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- HTML2Canvas Library for Image Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --accent: #ec4899;
        --bg-dark: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --success: #10b981;
        --danger: #ef4444;
        --glass: blur(12px);
        --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 80px;
        background-image:
          radial-gradient(
            circle at 10% 20%,
            rgba(99, 102, 241, 0.15) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(236, 72, 153, 0.15) 0%,
            transparent 40%
          );
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }
      button {
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
      }
      .btn-primary {
        background: var(--gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--text-main);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .btn-danger {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
      }
      .btn-success {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* Page Loader */
      .page-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        width: 100%;
        min-height: 200px;
      }
      .card {
        background: var(--bg-card);
        backdrop-filter: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        margin-bottom: 24px;
      }
      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-cat {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
      }
      .badge-sold {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      .badge-open {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        cursor: pointer;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
        padding: 16px 0;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-actions {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .view {
        display: none;
        padding: 40px 0;
        animation: fadeIn 0.4s ease;
      }
      .view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Forms */
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
      }
      /* Event Cards */
      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
      }
      .event-card {
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
        cursor: pointer;
        border: 1px solid var(--border);
      }
      .event-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }
      .event-img {
        height: 180px;
        background-size: cover;
        background-position: center;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      /* Detail View */
      .detail-header {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
      }
      .detail-img {
        flex: 1;
        min-width: 300px;
        height: 350px;
        border-radius: 16px;
        background-size: cover;
        background-position: center;
      }
      .detail-content {
        flex: 1;
        min-width: 300px;
      }
      .ticket-list-container {
        margin-top: 24px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.2);
      }
      .ticket-item {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      @media (min-width: 768px) {
        .ticket-item {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }
      .ticket-item:last-child {
        border-bottom: none;
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px;
        border-radius: 8px;
      }
      .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
      }
      .qty-btn:hover:not(:disabled) {
        background: var(--primary);
      }
      .qty-value {
        min-width: 24px;
        text-align: center;
        font-weight: 600;
      }
      /* Price Breakdown */
      .price-breakdown {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        margin-top: 20px;
      }
      .price-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .price-row.total {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-main);
        margin-top: 8px;
        border-top: 1px dashed var(--border);
        padding-top: 8px;
      }
      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        text-align: left;
        padding: 16px;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }
      th {
        color: var(--text-muted);
      }
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      table {
        min-width: 800px;
      }
      /* Modals */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--bg-dark);
        border: 1px solid var(--border);
      }
      /* Ticket Visual Styles */
      .tickets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
      }
      .ticket-visual {
        background: white;
        color: #1e293b;
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        position: relative;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
        cursor: pointer;
      }
      .ticket-visual:hover {
        transform: scale(1.02);
      }
      .tv-main {
        flex: 1;
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-right: 2px dashed #cbd5e1;
      }
      .tv-stub {
        width: 120px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        text-align: center;
      }
      .tv-cutout {
        position: absolute;
        width: 24px;
        height: 24px;
        background-color: var(--bg-dark);
        border-radius: 50%;
        top: 50%;
        left: 108px;
        transform: translateY(-50%);
        z-index: 10;
      }
      .tv-qr {
        width: 100px;
        height: 100px;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        padding: 4px;
        border-radius: 8px;
      }
      .tv-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      .tv-value {
        font-weight: 600;
        font-size: 0.95rem;
        color: #0f172a;
      }
      .tv-title {
        font-size: 1.25rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 16px;
        line-height: 1.2;
      }
      .tv-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .tv-row i {
        color: var(--primary);
      }
      .hidden {
        display: none !important;
      }
      /* Toast */
      #toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 380px;
      }
      .toast {
        min-width: 320px;
        padding: 16px 20px;
        border-radius: 12px;
        background: rgba(30, 41, 59, 0.96);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        gap: 14px;
        color: white;
        transform: translateX(120%);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }
      .toast.success {
        border-left: 5px solid var(--success);
      }
      .toast.error {
        border-left: 5px solid var(--danger);
      }
      .toast.info {
        border-left: 5px solid var(--primary);
      }
      /* Preloader */
      #preloader {
        position: fixed;
        inset: 0;
        background: var(--bg-dark);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.5s ease;
      }
      .loader-ring {
        width: 64px;
        height: 64px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      /* Mobile Nav */
      .mobile-bottom-nav {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--border);
        z-index: 99;
        justify-content: space-around;
        align-items: center;
      }
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 12px;
        transition: all 0.2s;
      }
      .mobile-nav-item i {
        font-size: 1.5rem;
        margin-bottom: 2px;
      }
      .mobile-nav-item.active {
        color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
      }

      /* Ticket Detail Modal Specifics */
      #ticketDetailModal .modal {
        max-width: 800px;
        background: var(--bg-dark);
      }
      #ticketDetailModal .modal-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .ticket-action-bar {
        display: flex;
        gap: 12px;
        width: 100%;
        margin-top: 20px;
        justify-content: center;
      }
      /* Larger Ticket for Modal */
      .ticket-visual-large {
        transform: scale(1.2);
        margin: 40px 0;
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 70px;
        }
        .nav-actions {
          display: none;
        }
        .mobile-bottom-nav {
          display: flex;
        }
        nav {
          justify-content: center;
        }
        header {
          padding: 10px 0;
        }
        .events-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        .modal-overlay {
          justify-content: flex-end;
          background: transparent;
        }
        .modal {
          width: 100%;
          max-width: 100%;
          border-radius: 24px 24px 0 0;
          transform: translateY(100%);
          transition: transform 0.3s;
          padding-bottom: 30px;
        }
        .modal-overlay.open .modal {
          transform: translateY(0);
        }
        #toast-container {
          top: 16px;
          right: 16px;
          left: 16px;
          max-width: none;
        }
        .toast {
          min-width: auto;
        }
        .ticket-visual {
          flex-direction: column;
        }
        .tv-main {
          border-right: none;
          border-bottom: 2px dashed #cbd5e1;
          padding: 20px;
        }
        .tv-stub {
          width: 100%;
          padding: 15px;
          flex-direction: row;
          gap: 20px;
          justify-content: space-between;
          align-items: center;
        }
        .tv-cutout {
          display: none;
        }
        .tv-qr {
          width: 60px;
          height: 60px;
          margin-bottom: 0;
        }
        /* Ticket Detail Modal Mobile */
        #ticketDetailModal .modal {
          height: 90vh;
          transform: translateY(100%);
        }
        #ticketDetailModal .modal-overlay.open .modal {
          transform: translateY(0);
        }
        .ticket-visual-large {
          transform: scale(1); /* Reset scale on mobile, let modal scroll */
          width: 100%;
          margin: 20px 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- PRELOADER -->
    <div id="preloader">
      <div class="loader-ring"></div>
      <h2
        style="
          background: var(--gradient);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        "
      >
        EventHub
      </h2>
    </div>

    <!-- HEADER -->
    <header>
      <div class="container">
        <nav>
          <div class="logo" onclick="app.router.navigate('home')">
            <i class="ph ph-ticket"></i> 21Events
          </div>
          <div class="nav-actions">
            <button
              class="btn btn-secondary"
              onclick="app.router.navigate('home')"
            >
              Find Events
            </button>
            <div id="loggedOutNav" style="display: flex; gap: 10px">
              <div
                class="btn btn-secondary"
                onclick="app.ui.openAuthModal('login')"
              >
                Login
              </div>
              <div
                class="btn btn-primary"
                onclick="app.ui.openAuthModal('signup')"
              >
                Sign Up
              </div>
            </div>
            <div
              id="loggedInNav"
              style="display: none; gap: 10px; align-items: center"
            >
              <span id="userNameDisplay" style="font-weight: 500"></span>
              <button
                class="btn btn-secondary"
                onclick="app.router.navigate('dashboard')"
              >
                My Tickets
              </button>
              <button id="roleBtn" class="btn btn-primary">My Dashboard</button>
              <button
                class="btn btn-secondary"
                style="padding: 8px"
                onclick="app.auth.logout()"
                title="Logout"
              >
                <i class="ph ph-sign-out"></i>
              </button>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- MOBILE NAV -->
    <div class="mobile-bottom-nav">
      <div class="mobile-nav-item active" onclick="app.router.navigate('home')">
        <i class="ph ph-house"></i><span>Home</span>
      </div>
      <div
        class="mobile-nav-item"
        id="mobileTicketsBtn"
        onclick="app.router.navigate('dashboard')"
      >
        <i class="ph ph-ticket"></i><span>Tickets</span>
      </div>
      <div class="mobile-nav-item" id="mobileDashBtn">
        <i class="ph ph-squares-four"></i><span>Dashboard</span>
      </div>
      <div
        class="mobile-nav-item"
        id="mobileProfileBtn"
        onclick="app.ui.openAuthModal('login')"
      >
        <i class="ph ph-user"></i><span>Profile</span>
      </div>
    </div>

    <main id="app" class="container"></main>
    <div id="toast-container"></div>

    <!-- 1. AUTH MODAL -->
    <div class="modal-overlay" id="authModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 id="authTitle">Login</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('authModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form id="authForm" onsubmit="app.auth.handleAuth(event)">
          <div class="form-group">
            <label>Email</label
            ><input
              type="email"
              name="email"
              required
              placeholder="user@example.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label
            ><input
              type="password"
              name="password"
              required
              placeholder="•••••"
            />
          </div>
          <!-- Fields for Sign Up Only -->
          <div id="signupFields" style="display: none">
            <div class="form-group">
              <label>Full Name</label
              ><input type="text" name="name" placeholder="John Doe" />
            </div>
            <div class="form-group">
              <label>I am a(n):</label>
              <div style="display: flex; gap: 20px; margin-top: 5px">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    cursor: pointer;
                    color: var(--text-main);
                  "
                >
                  <input
                    type="radio"
                    name="role"
                    value="attendee"
                    checked
                    style="width: auto; margin: 0"
                  />
                  Attendee
                </label>
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    cursor: pointer;
                    color: var(--text-main);
                  "
                >
                  <input
                    type="radio"
                    name="role"
                    value="organizer"
                    style="width: auto; margin: 0"
                    onchange="app.ui.toggleBrandName(true)"
                  />
                  Organizer
                </label>
              </div>
            </div>
            <div
              class="form-group"
              id="brandNameGroup"
              style="display: none; animation: fadeIn 0.3s ease"
            >
              <label>Brand Name (Optional)</label
              ><input
                type="text"
                name="brandName"
                placeholder="e.g. Studio 54"
              />
            </div>
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center"
          >
            Submit
          </button>
        </form>
        <p
          style="
            text-align: center;
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
          "
        >
          <span id="authSwitchText">New here?</span>
          <a
            href="#"
            style="color: var(--primary)"
            onclick="app.ui.toggleAuthMode()"
            >Click here</a
          >
        </p>
      </div>
    </div>

    <!-- 2. CHECKOUT MODAL -->
    <div class="modal-overlay" id="checkoutModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Checkout</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('checkoutModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div
          id="checkoutSummary"
          class="card"
          style="background: rgba(255, 255, 255, 0.03); margin-bottom: 20px"
        ></div>
        <form onsubmit="app.handlers.processPayment(event)">
          <div class="form-group">
            <label>Cardholder Name</label
            ><input type="text" required placeholder="John Doe" />
          </div>
          <div class="form-group">
            <label>Card Number</label
            ><input
              type="text"
              required
              placeholder="0000 0000 0000 0000"
              maxlength="19"
            />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px">
            <div class="form-group">
              <label>Expiry</label
              ><input type="text" required placeholder="MM/YY" maxlength="5" />
            </div>
            <div class="form-group">
              <label>CVC</label
              ><input type="text" required placeholder="123" maxlength="3" />
            </div>
          </div>
          <button
            type="submit"
            id="payBtn"
            class="btn btn-primary"
            style="
              width: 100%;
              justify-content: center;
              font-size: 1.1rem;
              padding: 16px;
            "
          >
            Pay <span id="payAmount"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- 3. ORGANIZER CREATE/EDIT MODAL -->
    <div class="modal-overlay" id="eventModal">
      <div class="modal card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2 id="modalTitle">Create Event</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('eventModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form onsubmit="app.handlers.saveEvent(event)">
          <input type="hidden" id="eventIdHidden" />
          <div class="form-group">
            <label>Event Title</label
            ><input type="text" id="eventTitle" required />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
            <div class="form-group">
              <label>Date</label><input type="date" id="eventDate" required />
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="eventCategory">
                <option>Music</option>
                <option>Tech</option>
                <option>Business</option>
                <option>Art</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Location</label
            ><input type="text" id="eventLocation" required />
          </div>
          <!-- Image Upload -->
          <div class="form-group">
            <label>Event Image</label>
            <input
              type="file"
              id="eventImageInput"
              accept="image/*"
              onchange="app.handlers.previewImage(this)"
            />
            <div
              id="imagePreviewContainer"
              style="margin-top: 10px; display: none; position: relative"
            >
              <img
                id="imgPreview"
                src=""
                style="
                  width: 100%;
                  height: 200px;
                  object-fit: cover;
                  border-radius: 8px;
                  border: 1px solid var(--border);
                "
              />
              <button
                type="button"
                onclick="app.handlers.clearImage()"
                style="
                  position: absolute;
                  top: 10px;
                  right: 10px;
                  background: rgba(0, 0, 0, 0.7);
                  color: white;
                  border-radius: 50%;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                "
              >
                &times;
              </button>
            </div>
          </div>
          <div style="margin-bottom: 16px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0">Ticket Types</label>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                onclick="app.handlers.addTicketRow()"
              >
                <i class="ph ph-plus"></i> Add Type
              </button>
            </div>
            <div id="ticketTypesContainer"></div>
          </div>
          <button
            type="submit"
            id="saveEventBtn"
            class="btn btn-primary"
            style="width: 100%"
          >
            Publish Event
          </button>
        </form>
      </div>
    </div>

    <!-- 4. WITHDRAWAL MODAL -->
    <div class="modal-overlay" id="withdrawalModal">
      <div class="modal card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2>Request Withdrawal</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('withdrawalModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form onsubmit="app.handlers.requestWithdrawal(event)">
          <div class="form-group">
            <label>Available to Withdraw (₦)</label
            ><input
              type="number"
              id="withdrawalAmountInput"
              name="amount"
              readonly
              step="0.01"
            />
          </div>
          <div class="form-group">
            <label>Bank Name</label
            ><input
              type="text"
              name="bankName"
              required
              placeholder="e.g. Access Bank"
            />
          </div>
          <div class="form-group">
            <label>Account Number</label
            ><input
              type="text"
              name="accountNum"
              required
              placeholder="Last 4 digits"
            />
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Submit Request
          </button>
        </form>
      </div>
    </div>

    <!-- 5. TICKET DETAIL / SHARE MODAL -->
    <div class="modal-overlay" id="ticketDetailModal">
      <div class="modal">
        <div class="modal-content">
          <div style="width: 100%; display: flex; justify-content: flex-end">
            <button
              class="btn btn-secondary"
              style="padding: 8px"
              onclick="app.ui.closeModal('ticketDetailModal')"
            >
              <i class="ph ph-x"></i>
            </button>
          </div>
          <!-- Container to capture for Image -->
          <div
            id="ticketForCapture"
            style="position: relative; transform-origin: center top"
          >
            <!-- Ticket will be injected here -->
          </div>

          <div class="ticket-action-bar">
            <button
              class="btn btn-primary"
              onclick="app.handlers.downloadTicket()"
            >
              <i class="ph ph-download-simple"></i> Download
            </button>
            <button
              class="btn btn-success"
              onclick="app.handlers.shareTicket()"
            >
              <i class="ph ph-share-network"></i> Share Image
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // CONFIGURATION
      // ==========================================
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwC84QF4q6lPfTDsbnnWbWfH0nHX9k0ID_iNdeyPoE3CQ-YA38K5lC_Yjr2h9cMHSP8cg/exec";

      // Currency to NGN
      const fmtMoney = (amount) => {
        const num = parseFloat(amount) || 0;
        return "₦" + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };

      // ==========================================
      // IMAGE COMPRESSION HELPER
      // ==========================================
      const compressImage = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              let width = img.width;
              let height = img.height;
              const MAX_WIDTH = 400;
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
              const canvas = document.createElement("canvas");
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL("image/jpeg", 0.5));
            };
            img.onerror = (err) => reject(err);
          };
          reader.onerror = (err) => reject(err);
        });
      };

      // ==========================================
      // API HELPER
      // ==========================================
      const api = {
        post: async (action, data = {}) => {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify({ ...data, action }),
              signal: controller.signal,
            });
            clearTimeout(timeoutId);
            const json = await response.json();
            if (json.status === "error") throw new Error(json.message);
            return json;
          } catch (e) {
            console.error("API Error:", e);
            if (e.name !== "AbortError") {
              app.ui.showToast(e.message || "Network Error", "error");
            }
            return null;
          }
        },
        getEventsCached: async () => {
          const cached = localStorage.getItem("eh_events_cache");
          let cachedData = null;
          if (cached) {
            try {
              cachedData = JSON.parse(cached);
            } catch (e) {}
          }
          const freshRes = await api.post("getEvents");
          if (freshRes && freshRes.data) {
            localStorage.setItem(
              "eh_events_cache",
              JSON.stringify(freshRes.data),
            );
            return freshRes.data;
          }
          if (cachedData) return cachedData;
          return [];
        },
      };

      // ==========================================
      // APPLICATION LOGIC
      // ==========================================
      const app = {
        state: {
          isLoginMode: true,
          cart: {},
          feePercentage: 0.05,
          currentEventId: null,
          currentEventData: null,
          currentUser: JSON.parse(localStorage.getItem("eh_session")) || null,
          currentTicketData: null, // Holds data for ticket modal
        },
        init: async () => {
          app.ui.checkSession();
          const preloader = document.getElementById("preloader");
          setTimeout(() => {
            preloader.style.opacity = "0";
            setTimeout(() => preloader.remove(), 500);
          }, 600);
          app.router.navigate("home");
        },
        router: {
          navigate: async (viewName, params = null) => {
            const main = document.getElementById("app");
            app.router.current = viewName;
            window.scrollTo(0, 0);
            app.ui.updateMobileNav(viewName);
            if (viewName === "home") app.views.renderHome(main);
            if (viewName === "dashboard") app.views.renderMyTickets(main);
            if (viewName === "event") app.views.renderEventDetail(main, params);
            if (viewName === "organizer")
              app.views.renderOrganizerDashboard(main);
          },
        },
        views: {
          renderHome: async (container) => {
            const cached = localStorage.getItem("eh_events_cache");
            if (cached) {
              const events = JSON.parse(cached);
              container.innerHTML = app.views.generateEventGrid(events);
              api.getEventsCached().then((freshEvents) => {
                if (app.router.current === "home")
                  container.innerHTML =
                    app.views.generateEventGrid(freshEvents);
              });
            } else {
              container.innerHTML = `<div class="page-loader"><div class="loader-ring" style="width:40px; height:40px; margin:0;"></div></div>`;
              const events = await api.getEventsCached();
              if (app.router.current === "home")
                container.innerHTML = app.views.generateEventGrid(events);
            }
          },
          generateEventGrid: (events) => {
            return `
                    <div class="view active">
                      <section class="hero" style="text-align:center; padding:40px 0;">
                        <span class="badge badge-cat" style="margin-bottom:16px; display:inline-block;">#1 Event Platform</span>
                        <h1>Create, Promote & Sell<br>Your Events</h1>
                        <p style="font-size:1.1rem; color:var(--text-muted); margin-bottom:30px; max-width:600px; margin-left:auto; margin-right:auto;">
                          The all-in-one platform for organizers and attendees.
                        </p>
                      </section>
                      <div class="events-grid">
                        ${events
                          .map((e) => {
                            if (!e.image)
                              e.image = `https://picsum.photos/seed/${e.title || "default"}/400/225`;
                            const internalTickets = e.tickets.filter(
                              (t) => !t.isExternal,
                            );
                            const priceDisplay =
                              internalTickets.length > 0
                                ? fmtMoney(
                                    Math.min(
                                      ...internalTickets.map((t) => t.price),
                                    ),
                                  )
                                : "Free/Ext";
                            return `
                            <div class="card event-card" onclick="app.router.navigate('event', '${e.id}')">
                              <div class="event-img" style="background-image: url('${e.image}')"></div>
                              <span class="badge badge-cat">${e.category}</span>
                              <h3 style="margin:10px 0;">${e.title}</h3>
                              <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:16px;">
                                <i class="ph ph-calendar-blank"></i> ${new Date(e.date).toLocaleDateString()} &bull; ${e.location}
                              </div>
                              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto;">
                                <span style="font-weight:700;">${priceDisplay}</span>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">Buy Ticket</button>
                              </div>
                            </div>`;
                          })
                          .join("")}
                      </div>
                    </div>`;
          },
          renderEventDetail: async (container, eventId) => {
            container.innerHTML = `<div class="page-loader"><div class="loader-ring" style="width:30px; height:30px; margin:0 auto;"></div></div>`;
            const events = await api.getEventsCached();
            const event = events.find((e) => e.id === eventId);
            if (!event) return app.router.navigate("home");
            app.state.currentEventId = eventId;
            app.state.currentEventData = event;
            app.state.cart = {};
            event.tickets.forEach((t) => {
              if (!t.isExternal) app.state.cart[t.ticketId] = 0;
            });
            container.innerHTML = `
                    <div class="view active">
                      <button class="btn btn-secondary" onclick="app.router.navigate('home')" style="margin-bottom:20px;"><i class="ph ph-arrow-left"></i> Back</button>
                      <div class="detail-header">
                        <div class="detail-img" style="background-image:url('${event.image || `https://picsum.photos/seed/${event.title || "default"}/400/225`}');"></div>
                        <div class="detail-content">
                          <h1>${event.title}</h1>
                          <div style="color:var(--text-muted); margin-bottom:24px;">
                            <i class="ph ph-calendar-blank"></i> ${new Date(event.date).toDateString()}<br>
                            <i class="ph ph-map-pin"></i> ${event.location}
                          </div>
                          <div class="ticket-list-container">
                            ${event.tickets
                              .map((ticket) => {
                                if (ticket.isExternal)
                                  return `<div class="ticket-item"><div class="ticket-info"><strong>${ticket.type}</strong><div class="ticket-meta">External</div></div><a href="#" class="btn btn-secondary">Link</a></div>`;
                                const remaining = ticket.qty - ticket.sold;
                                const isSoldOut = remaining <= 0;
                                return `
                                <div class="ticket-item">
                                  <div class="ticket-info">
                                    <div class="ticket-name">${ticket.type} ${isSoldOut ? "(Sold Out)" : ""}</div>
                                    <div class="ticket-meta">${fmtMoney(ticket.price)} • ${remaining} left</div>
                                  </div>
                                  ${
                                    !isSoldOut
                                      ? `
                                    <div class="qty-control">
                                      <button class="qty-btn" onclick="app.handlers.updateTicketQty('${ticket.ticketId}', -1)">-</button>
                                      <span class="qty-value" id="qty-${ticket.ticketId}">0</span>
                                      <button class="qty-btn" onclick="app.handlers.updateTicketQty('${ticket.ticketId}', 1)">+</button>
                                    </div>`
                                      : '<button class="btn btn-secondary" disabled>Sold Out</button>'
                                  }
                                </div>`;
                              })
                              .join("")}
                          </div>
                          <div class="price-breakdown">
                            <div id="breakdownItems"></div>
                            <div class="price-row"><span>Service Fee (5%)</span><span id="feeDisplay">${fmtMoney(0)}</span></div>
                            <div class="price-row total"><span>Total</span><span id="totalDisplay">${fmtMoney(0)}</span></div>
                          </div>
                          <button id="buyBtn" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:20px; padding:16px;" disabled onclick="app.handlers.initBuy()">Select Tickets</button>
                        </div>
                      </div>
                    </div>`;
            app.handlers.updateSummary();
          },
          renderMyTickets: async (container) => {
            if (!app.state.currentUser) {
              app.ui.openAuthModal("login");
              return;
            }
            const user = app.state.currentUser;
            const buyerId = user.id || user.user_id || null;
            if (!buyerId) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="text-align:center; padding:40px; color:#f87171;"><p>Error: No user ID found. Please log out and log in again.</p></div></div>`;
              return;
            }
            container.innerHTML = `<div class="page-loader"><div class="loader-ring" style="width:40px; height:40px; margin:0;"></div><span style="margin-left:10px; color:var(--text-muted);">Loading Tickets...</span></div>`;
            const purchaseRes = await api.post("getPurchases", { buyerId });
            if (
              !purchaseRes ||
              purchaseRes.status !== "success" ||
              !Array.isArray(purchaseRes.data)
            ) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="padding:20px; color:#f87171;"><p>Could not load your tickets.</p></div></div>`;
              return;
            }
            if (purchaseRes.data.length === 0) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="text-align:center; padding:40px; color:var(--text-muted);"><i class="ph ph-ticket" style="font-size:3rem; margin-bottom:10px;"></i><p>You haven't purchased any tickets yet.</p><button class="btn btn-primary" style="margin-top:20px;" onclick="app.router.navigate('home')">Browse Events</button></div></div>`;
              return;
            }
            const eventsRes = await api.getEventsCached();
            const eventsMap = new Map(eventsRes.map((e) => [e.id, e]));

            // Generate HTML for tickets
            const ticketsHTML = purchaseRes.data
              .map((p) => {
                const evt = eventsMap.get(p.event_id);
                const qrData = JSON.stringify({
                  pid: p.purchase_id,
                  evt: p.event_id,
                  qty: p.quantity,
                  type: p.ticket_type,
                });
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;

                // Store data for the modal in a data attribute
                const ticketDataStr = encodeURIComponent(
                  JSON.stringify({
                    title: evt ? evt.title : "Unknown Event",
                    date: evt ? new Date(evt.date).toLocaleDateString() : "TBD",
                    type: p.ticket_type,
                    qty: p.quantity,
                    total: fmtMoney(p.total_paid),
                    qrData: qrData,
                    id: p.purchase_id,
                  }),
                );

                return `
              <div class="ticket-visual" onclick="app.handlers.openTicketDetail('${ticketDataStr}')">
                <div class="tv-cutout"></div>
                <div class="tv-main">
                  <div>
                    <div class="tv-label">EVENT</div>
                    <h3 class="tv-title">${evt ? evt.title : "Unknown Event"}</h3>
                    <div class="tv-row"><i class="ph ph-calendar-blank"></i><span>${evt ? new Date(evt.date).toLocaleDateString() : "TBD"}</span></div>
                    <div class="tv-row"><i class="ph ph-ticket"></i><span>${p.ticket_type} × ${p.quantity}</span></div>
                  </div>
                  <div style="margin-top:20px;">
                    <div class="tv-label">TOTAL PAID</div>
                    <div class="tv-value" style="font-size:1.1rem; color:var(--primary);">${fmtMoney(p.total_paid)}</div>
                  </div>
                </div>
                <div class="tv-stub">
                  <img src="${qrUrl}" alt="QR Code" class="tv-qr" />
                  <div class="tv-label">Tap to View</div>
                  <div class="tv-value" style="font-size:0.75rem; color:#64748b;">ID: ${p.purchase_id.slice(-6)}</div>
                </div>
              </div>`;
              })
              .join("");
            container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div style="margin-bottom: 10px; color: var(--text-muted); font-size: 0.9rem; text-align: right;">Tap a ticket to view/share</div><div class="tickets-grid">${ticketsHTML}</div></div>`;
          },
          renderOrganizerDashboard: async (container) => {
            const user = app.state.currentUser;
            if (!user) {
              app.router.navigate("home");
              return;
            }
            container.innerHTML = `<div class="view active"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h1>Organizer Dashboard</h1><button class="btn btn-primary" onclick="app.handlers.openEventModal()"><i class="ph ph-plus"></i> Create Event</button></div><div class="page-loader"><div class="loader-ring" style="width:30px; height:30px; margin:0;"></div><span style="margin-left:10px; color:var(--text-muted);">Loading...</span></div></div>`;

            const [eventsRes, wRes, pRes] = await Promise.all([
              api.post("getEvents"),
              api.post("getWithdrawals", {
                organizerId:
                  app.state.currentUser.id || app.state.currentUser.user_id,
              }),
              api.post("getPurchases"),
            ]);
            const allEvents = eventsRes?.data ?? [];
            const withdrawals = wRes?.data ?? [];
            const allPurchases = pRes?.data ?? [];
            const currentOrganizerId = String(user.id || user.user_id || "");
            const myEvents = allEvents.filter(
              (e) => String(e.organizerId || "") === currentOrganizerId,
            );
            const myEventIds = myEvents.map((e) => e.id);
            const mySales = allPurchases.filter((p) =>
              myEventIds.includes(p.event_id),
            );

            // Calculate Organizer Revenue (Excluding the 5% fee)
            const grossRevenue = mySales.reduce((sum, p) => {
              const total = Number(p.total_paid || 0);
              const organizerShare = p.subtotal
                ? Number(p.subtotal)
                : total / 1.05;
              return sum + organizerShare;
            }, 0);

            const totalPaidOut = withdrawals
              .filter((w) => w.status === "Approved" || w.status === "Pending")
              .reduce((sum, w) => sum + Number(w.amount || 0), 0);
            const balance = grossRevenue - totalPaidOut;
            const totalTicketsSold = myEvents.reduce(
              (acc, e) =>
                acc + e.tickets.reduce((a, t) => a + (t.sold || 0), 0),
              0,
            );

            container.innerHTML = `
          <div class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h1>Organizer Dashboard</h1>
              <button class="btn btn-primary" onclick="app.handlers.openEventModal()"><i class="ph ph-plus"></i> Create Event</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom:30px;">
              <div class="card"><h3>Available Balance</h3><h2 style="color:var(--primary); margin:10px 0;">${fmtMoney(balance)}</h2></div>
              <div class="card"><h3>Total Tickets Sold</h3><h2 style="margin:10px 0;">${totalTicketsSold}</h2></div>
              <div class="card" style="border-color:var(--accent); background:rgba(236,72,153,0.05)"><h3>Total Paid Out</h3><h2 style="color:var(--accent); margin:10px 0;">${fmtMoney(totalPaidOut)}</h2></div>
            </div>
            <div class="card">
              <h2>My Events</h2>
              ${
                myEvents.length === 0
                  ? '<p style="color:var(--text-muted); text-align:center; padding:40px 0;">You haven\'t created any events yet.</p>'
                  : `
              <div class="table-wrapper">
                <table>
                  <thead><tr><th>Event</th><th>Date</th><th>Sales</th><th>Action</th></tr></thead>
                  <tbody>
                    ${myEvents
                      .map((e) => {
                        const totalQty = e.tickets.reduce(
                          (s, t) => s + (t.qty || 0),
                          0,
                        );
                        const sold = e.tickets.reduce(
                          (s, t) => s + (t.sold || 0),
                          0,
                        );
                        const isSoldOut = totalQty > 0 && sold >= totalQty;
                        return `<tr><td><strong>${e.title}</strong>${isSoldOut ? '<span class="badge badge-sold" style="margin-left:8px;">Sold Out</span>' : '<span class="badge badge-open" style="margin-left:8px;">Active</span>'}</td><td>${new Date(e.date).toLocaleDateString("en-GB")}</td><td>${sold} / ${totalQty}</td><td style="white-space:nowrap;"><button class="btn btn-secondary btn-sm" onclick="app.handlers.editEvent('${e.id}')" style="margin-right:8px;">Edit</button><button class="btn btn-danger btn-sm" onclick="app.handlers.deleteEvent('${e.id}')">Delete</button></td></tr>`;
                      })
                      .join("")}
                  </tbody>
                </table>
              </div>`
              }
            </div>
            <div class="card">
              <h2>Payout History</h2>
              ${
                withdrawals.length === 0
                  ? '<p style="color:var(--text-muted)">No withdrawal requests yet.</p>'
                  : `
                <div class="table-wrapper">
                  <table>
                    <thead><tr><th>Amount</th><th>Bank</th><th>Account</th><th>Status</th><th>Date</th></tr></thead>
                    <tbody>
                      ${withdrawals.map((w) => `<tr><td>${fmtMoney(w.amount)}</td><td>${w.bankName || "-"}</td><td>${w.accountNum || "-"}</td><td><span class="badge" style="background:${w.status === "Approved" ? "var(--success)" : w.status === "Pending" ? "#f59e0b" : "var(--text-muted)"}">${w.status}</span></td><td>${new Date(w.date).toLocaleDateString("en-GB")}</td></tr>`).join("")}
                    </tbody>
                  </table>
                </div>`
              }
              <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-primary" onclick="app.handlers.openWithdrawalModal(${balance})" ${balance <= 0 ? "disabled" : ""}>Request Withdrawal</button>
              </div>
            </div>
          </div>`;
          },
        },
        handlers: {
          updateTicketQty: (ticketId, change) => {
            const ticket = app.state.currentEventData.tickets.find(
              (t) => String(t.ticketId) == String(ticketId),
            );
            if (!ticket) return;
            const current = app.state.cart[ticketId] || 0;
            const newQty = current + change;
            if (newQty < 0) return;
            const remaining = ticket.qty - ticket.sold;
            if (newQty > remaining) {
              app.ui.showToast(
                `Sorry, only ${remaining} tickets remaining for ${ticket.type}.`,
                "error",
              );
              return;
            }
            app.state.cart[ticketId] = newQty;
            const qtyEl = document.getElementById(`qty-${ticketId}`);
            if (qtyEl) qtyEl.innerText = newQty;
            app.handlers.updateSummary();
          },
          updateSummary: () => {
            if (!app.state.currentEventData) return;
            let subtotal = 0;
            let breakdownHTML = "";
            let itemCount = 0;
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => String(t.ticketId) == String(tid),
                );
                if (ticket) {
                  subtotal += ticket.price * qty;
                  itemCount += qty;
                  breakdownHTML += `<div class="price-row"><span>${ticket.type} (x${qty})</span><span>${fmtMoney(ticket.price * qty)}</span></div>`;
                }
              }
            });
            const fee = subtotal * app.state.feePercentage;
            const total = subtotal + fee;
            const breakdownEl = document.getElementById("breakdownItems");
            if (breakdownEl) breakdownEl.innerHTML = breakdownHTML;
            const feeEl = document.getElementById("feeDisplay");
            if (feeEl) feeEl.innerText = fmtMoney(fee);
            const totalEl = document.getElementById("totalDisplay");
            if (totalEl) totalEl.innerText = fmtMoney(total);
            const btn = document.getElementById("buyBtn");
            if (btn) {
              btn.disabled = itemCount === 0;
              btn.innerText =
                itemCount === 0
                  ? "Select Tickets"
                  : `Checkout - ${fmtMoney(total)}`;
            }
          },
          initBuy: () => {
            if (!app.state.currentUser) {
              app.ui.showToast(
                "Please create an account or login to purchase tickets.",
                "info",
              );
              app.state.isLoginMode = false;
              app.ui.toggleAuthMode();
              app.ui.openModal("authModal");
              return;
            }
            app.ui.openModal("checkoutModal");
            let subtotal = 0;
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => String(t.ticketId) == String(tid),
                );
                if (ticket) subtotal += ticket.price * qty;
              }
            });
            const fee = subtotal * app.state.feePercentage;
            const total = subtotal + fee;
            document.getElementById("checkoutSummary").innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><span>Subtotal</span><span>${fmtMoney(subtotal)}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Fee (5%)</span><span>${fmtMoney(fee)}</span></div>
                    <h3 style="text-align:right; margin-top:10px;">Total: ${fmtMoney(total)}</h3>
                  `;
            document.getElementById("payAmount").innerText = fmtMoney(total);
          },
          processPayment: async (e) => {
            e.preventDefault();
            const btn = document.getElementById("payBtn");
            const originalText = btn.innerHTML;
            app.ui.setLoading(btn, true);
            for (const [ticketId, qty] of Object.entries(app.state.cart)) {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => String(t.ticketId) == String(ticketId),
                );
                if (!ticket) {
                  app.ui.showToast(
                    `Error: Ticket ID ${ticketId} not found.`,
                    "error",
                  );
                  app.ui.setLoading(btn, false, originalText);
                  return;
                }
                const subtotal = ticket.price * qty;
                const fee = subtotal * app.state.feePercentage;
                const pRes = await api.post("purchase", {
                  event_id: app.state.currentEventId,
                  ticket_id: ticketId,
                  ticket_type: ticket.type,
                  quantity: qty,
                  subtotal: subtotal,
                  fee: fee,
                  total: subtotal + fee,
                  buyer_id:
                    app.state.currentUser.user_id || app.state.currentUser.id,
                });
                if (!pRes) {
                  app.ui.setLoading(btn, false, originalText);
                  return;
                }
              }
            }
            app.ui.setLoading(btn, false, originalText);
            app.ui.closeModal("checkoutModal");
            app.ui.showToast("Payment Successful!");
            app.router.navigate("dashboard");
          },
          openEventModal: () => {
            app.state.isEditing = false;
            app.state.editingId = null;
            document.getElementById("modalTitle").innerText = "Create Event";
            document.getElementById("saveEventBtn").innerText = "Publish Event";
            document.getElementById("eventIdHidden").value = "";
            document.getElementById("eventTitle").value = "";
            document.getElementById("eventDate").value = "";
            document.getElementById("eventLocation").value = "";
            document.getElementById("ticketTypesContainer").innerHTML = "";
            app.handlers.addTicketRow();
            app.handlers.clearImage();
            app.ui.openModal("eventModal");
          },
          editEvent: async (id) => {
            const res = await api.post("getEvents");
            const event = res.data.find((e) => e.id === id);
            if (!event) return;
            app.state.isEditing = true;
            app.state.editingId = id;
            document.getElementById("modalTitle").innerText = "Edit Event";
            document.getElementById("saveEventBtn").innerText = "Update Event";
            document.getElementById("eventIdHidden").value = id;
            document.getElementById("eventTitle").value = event.title;
            document.getElementById("eventDate").value = event.date;
            document.getElementById("eventLocation").value = event.location;
            const container = document.getElementById("ticketTypesContainer");
            container.innerHTML = "";
            event.tickets.forEach((t) => app.handlers.addTicketRow(t));
            const img = document.getElementById("imgPreview");
            const previewContainer = document.getElementById(
              "imagePreviewContainer",
            );
            if (event.image) {
              img.src = event.image;
              previewContainer.style.display = "block";
            } else {
              previewContainer.style.display = "none";
            }
            app.ui.openModal("eventModal");
          },
          addTicketRow: (data = null) => {
            const container = document.getElementById("ticketTypesContainer");
            const id = Date.now().toString();
            const ticketId = data ? data.ticketId : "new_" + id;
            const div = document.createElement("div");
            div.className = "ticket-type-row";
            div.innerHTML = `
                    <input type="hidden" class="t-id" value="${ticketId}" />
                    <button type="button" class="remove-ticket-btn" onclick="this.parentElement.remove()"><i class="ph ph-x"></i></button>
                    <div class="form-group"><label>Name</label><input type="text" class="t-name" value="${data ? data.type : ""}" required /></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                      <div><label>Price</label><input type="number" class="t-price" value="${data ? data.price : ""}" /></div>
                      <div><label>Qty</label><input type="number" class="t-qty" value="${data ? data.qty : ""}" /></div>
                    </div>
                  `;
            container.appendChild(div);
          },
          saveEvent: async (e) => {
            e.preventDefault();
            const btn = document.getElementById("saveEventBtn");
            app.ui.setLoading(btn, true);
            const title = document.getElementById("eventTitle").value.trim();
            const date = document.getElementById("eventDate").value;
            const location = document
              .getElementById("eventLocation")
              .value.trim();
            const category = document.getElementById("eventCategory").value;
            const fileInput = document.getElementById("eventImageInput");
            if (
              !app.state.currentUser ||
              !(app.state.currentUser.id || app.state.currentUser.user_id)
            ) {
              app.ui.showToast(
                "Session error – please log out and log in again",
                "error",
              );
              app.ui.setLoading(btn, false);
              return;
            }
            const organizerId =
              app.state.currentUser.id || app.state.currentUser.user_id;
            let imagePayload = "";
            if (fileInput.files.length > 0) {
              try {
                imagePayload = await compressImage(fileInput.files[0]);
              } catch (err) {
                console.error(err);
                app.ui.showToast(
                  "Failed to process image. Try a smaller image.",
                  "error",
                );
                app.ui.setLoading(btn, false);
                return;
              }
            } else if (app.state.isEditing) {
              const res = await api.post("getEvents");
              const existingEvent = res.data.find(
                (ev) => ev.id === app.state.editingId,
              );
              if (existingEvent && existingEvent.image) {
                imagePayload = existingEvent.image;
              } else {
                imagePayload = `https://picsum.photos/seed/${title || Date.now()}/400/225`;
              }
            } else {
              imagePayload = `https://picsum.photos/seed/${title || Date.now()}/400/225`;
            }
            const ticketRows = document.querySelectorAll(".ticket-type-row");
            const tickets = Array.from(ticketRows)
              .map((row) => ({
                ticketId: row.querySelector(".t-id").value,
                type: row.querySelector(".t-name").value.trim(),
                price: Number(row.querySelector(".t-price").value) || 0,
                qty: Number(row.querySelector(".t-qty").value) || 0,
              }))
              .filter((t) => t.type && t.qty > 0);
            const payload = {
              title,
              date,
              location,
              category,
              tickets,
              organizer_id: organizerId,
              imageBase64: imagePayload,
            };
            let res;
            if (app.state.isEditing) {
              payload.event_id = app.state.editingId;
              res = await api.post("updateEvent", payload);
            } else {
              res = await api.post("createEvent", payload);
            }
            app.ui.setLoading(
              btn,
              false,
              app.state.isEditing ? "Update Event" : "Publish Event",
            );
            if (res?.status === "success") {
              localStorage.removeItem("eh_events_cache");
              app.ui.closeModal("eventModal");
              app.ui.showToast(
                app.state.isEditing ? "Event updated!" : "Event published!",
              );
              app.router.navigate("organizer");
            } else {
              app.ui.showToast(res?.message || "Failed to save event", "error");
            }
          },
          previewImage: async (input) => {
            if (input.files && input.files[0]) {
              try {
                const compressedData = await compressImage(input.files[0]);
                const img = document.getElementById("imgPreview");
                const container = document.getElementById(
                  "imagePreviewContainer",
                );
                img.src = compressedData;
                container.style.display = "block";
              } catch (err) {
                console.error(err);
                app.ui.showToast("Error previewing image", "error");
              }
            }
          },
          clearImage: () => {
            const input = document.getElementById("eventImageInput");
            input.value = "";
            document.getElementById("imagePreviewContainer").style.display =
              "none";
          },
          deleteEvent: async (id) => {
            if (!confirm("Delete this event?")) return;
            await api.post("deleteEvent", { eventId: id });
            localStorage.removeItem("eh_events_cache");
            app.router.navigate("organizer");
          },
          openWithdrawalModal: (amount) => {
            document.getElementById("withdrawalAmountInput").value =
              amount.toFixed(2);
            app.ui.openModal("withdrawalModal");
          },
          requestWithdrawal: async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);

            // FIX: Robust ID retrieval
            const organizerId =
              app.state.currentUser.id || app.state.currentUser.user_id;

            if (!organizerId) {
              app.ui.showToast(
                "Error: User not identified. Please log in again.",
                "error",
              );
              return;
            }

            const res = await api.post("requestWithdrawal", {
              organizerId: organizerId, // Send the explicitly found ID
              amount: fd.get("amount"),
              bankName: fd.get("bankName"),
              accountNum: fd.get("accountNum"),
            });

            if (res) {
              app.ui.closeModal("withdrawalModal");
              app.ui.showToast("Request Sent!");
              app.router.navigate("organizer");
            }
          },
          // NEW: Ticket Share Handlers
          openTicketDetail: (dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            app.state.currentTicketData = data;
            const container = document.getElementById("ticketForCapture");

            // Generate high-res QR
            const highResQR = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(data.qrData)}`;

            // Build the HTML for the large ticket
            container.innerHTML = `
                <div class="ticket-visual ticket-visual-large" style="width: 600px; height: 300px;">
                    <div class="tv-cutout" style="left: 200px; width: 40px; height: 40px;"></div>
                    <div class="tv-main" style="padding: 40px; font-size: 1.2rem;">
                        <div>
                            <div class="tv-label" style="font-size: 0.9rem;">EVENT TICKET</div>
                            <h3 class="tv-title" style="font-size: 2rem;">${data.title}</h3>
                            <div class="tv-row" style="font-size: 1.2rem; gap: 12px;"><i class="ph ph-calendar-blank" style="font-size: 1.4rem;"></i><span>${data.date}</span></div>
                            <div class="tv-row" style="font-size: 1.2rem; gap: 12px;"><i class="ph ph-ticket" style="font-size: 1.4rem;"></i><span>${data.type} × ${data.qty}</span></div>
                        </div>
                        <div style="margin-top: 30px;">
                            <div class="tv-label" style="font-size: 0.9rem;">TOTAL PAID</div>
                            <div class="tv-value" style="font-size: 1.5rem; color:var(--primary);">${data.total}</div>
                        </div>
                    </div>
                    <div class="tv-stub" style="width: 220px; padding: 30px 10px;">
                        <img src="${highResQR}" alt="QR Code" style="width: 180px; height: 180px; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;" />
                        <div class="tv-label" style="font-size: 0.8rem; margin-top: 15px;">SCAN ENTRY</div>
                    </div>
                </div>
              `;
            app.ui.openModal("ticketDetailModal");
          },
          downloadTicket: async () => {
            const element = document.getElementById("ticketForCapture");
            app.ui.showToast("Generating image...", "info");
            try {
              const canvas = await html2canvas(element, {
                scale: 2,
                backgroundColor: "#ffffff",
              });
              const link = document.createElement("a");
              link.download = `ticket-${app.state.currentTicketData.id}.png`;
              link.href = canvas.toDataURL();
              link.click();
            } catch (err) {
              console.error(err);
              app.ui.showToast("Failed to download ticket.", "error");
            }
          },
          shareTicket: async () => {
            const element = document.getElementById("ticketForCapture");
            app.ui.showToast("Preparing share...", "info");
            try {
              const canvas = await html2canvas(element, {
                scale: 2,
                backgroundColor: "#ffffff",
              });
              canvas.toBlob(async (blob) => {
                const file = new File(
                  [blob],
                  `ticket-${app.state.currentTicketData.id}.png`,
                  { type: "image/png" },
                );
                if (navigator.share && navigator.canShare({ files: [file] })) {
                  try {
                    await navigator.share({
                      title: "My Event Ticket",
                      text: `Ticket for ${app.state.currentTicketData.title}`,
                      files: [file],
                    });
                  } catch (err) {
                    // User likely cancelled
                  }
                } else {
                  app.ui.showToast(
                    "Sharing not supported on this device/browser. Please download instead.",
                    "info",
                  );
                }
              });
            } catch (err) {
              console.error(err);
              app.ui.showToast("Failed to share ticket.", "error");
            }
          },
        },
        auth: {
          handleAuth: async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const endpoint = app.state.isLoginMode ? "login" : "register";
            let payload = Object.fromEntries(fd.entries());
            if (payload.email)
              payload.email = payload.email.trim().toLowerCase();
            if (payload.password) payload.password = payload.password.trim();
            if (!app.state.isLoginMode) {
              if (!payload.role) payload.role = "attendee";
              payload.organizer_name = payload.brandName || "";
              delete payload.brandName;
            } else {
              payload = {
                email: payload.email,
                password: payload.password,
                username: payload.email,
              };
            }
            const res = await api.post(endpoint, payload);
            if (res && res.status === "success" && res.user) {
              const normalizedUser = {
                ...res.user,
                id: res.user.id || res.user.user_id || String(Date.now()),
              };
              if (normalizedUser.password) delete normalizedUser.password;
              app.state.currentUser = normalizedUser;
              localStorage.setItem(
                "eh_session",
                JSON.stringify(normalizedUser),
              );
              app.ui.closeModal("authModal");
              app.ui.checkSession();

              // SMART REDIRECT LOGIC:
              const hasItemsInCart = Object.values(app.state.cart).some(
                (qty) => qty > 0,
              );
              if (hasItemsInCart && app.state.currentEventId) {
                app.ui.showToast("Account created! Proceeding to checkout...");
                app.ui.openModal("checkoutModal");
              } else {
                // Normal Redirect
                if (normalizedUser.role === "organizer") {
                  app.router.navigate("organizer");
                } else {
                  app.router.navigate("home");
                }
              }
              app.ui.showToast(
                "Welcome back, " + (normalizedUser.name || "User") + "!",
              );
            } else {
              app.ui.showToast(
                res?.message || "Login / registration failed",
                "error",
              );
            }
          },
          logout: () => {
            localStorage.removeItem("eh_session");
            app.state.currentUser = null;
            window.location.reload();
          },
        },
        ui: {
          setLoading: (btn, isLoading, originalText = "") => {
            if (isLoading) {
              btn.disabled = true;
              btn.innerHTML = `<span class="spinner"></span> Loading...`;
            } else {
              btn.disabled = false;
              btn.innerHTML =
                originalText || btn.dataset.originalText || "Submit";
            }
          },
          openModal: (id) => document.getElementById(id).classList.add("open"),
          closeModal: (id) =>
            document.getElementById(id).classList.remove("open"),
          openAuthModal: (mode = "login") => {
            app.state.isLoginMode = mode === "login";
            app.ui.toggleAuthMode();
            app.ui.openModal("authModal");
          },
          toggleAuthMode: () => {
            app.state.isLoginMode = !app.state.isLoginMode;
            const isLogin = app.state.isLoginMode;
            document.getElementById("authTitle").innerText = isLogin
              ? "Login"
              : "Sign Up";
            document.getElementById("signupFields").style.display = isLogin
              ? "none"
              : "block";
            document.querySelector("#authForm button").innerText = isLogin
              ? "Login"
              : "Sign Up";
            const nameInput = document.querySelector('input[name="name"]');
            if (nameInput) {
              if (isLogin) nameInput.removeAttribute("required");
              else nameInput.setAttribute("required", "");
            }
            if (isLogin) {
              document.getElementById("brandNameGroup").style.display = "none";
            } else {
              const radios = document.getElementsByName("role");
              let isOrg = false;
              for (let r of radios) {
                if (r.checked && r.value === "organizer") isOrg = true;
              }
              document.getElementById("brandNameGroup").style.display = isOrg
                ? "block"
                : "none";
            }
          },
          toggleBrandName: (show) => {
            const el = document.getElementById("brandNameGroup");
            el.style.display = show ? "block" : "none";
          },
          checkSession: () => {
            const user = app.state.currentUser;
            if (user) {
              // FIX: Normalize ID. If 'id' is missing but 'user_id' exists, use it.
              if (!user.id && user.user_id) {
                user.id = user.user_id;
              }

              document.getElementById("loggedOutNav").style.display = "none";
              document.getElementById("loggedInNav").style.display = "flex";
              document.getElementById("userNameDisplay").innerText = user.name;

              const roleBtn = document.getElementById("roleBtn");
              const mobileDash = document.getElementById("mobileDashBtn");
              const mobileTickets = document.getElementById("mobileTicketsBtn");
              const mobileProfile = document.getElementById("mobileProfileBtn");

              mobileTickets.onclick = () => app.router.navigate("dashboard");
              mobileProfile.onclick = () => app.auth.logout();
              mobileProfile.querySelector("span").innerText = "Logout";
              mobileProfile.querySelector("i").className = "ph ph-sign-out";

              if (user.role === "organizer") {
                roleBtn.innerText = "Organizer Panel";
                roleBtn.onclick = () => app.router.navigate("organizer");
                mobileDash.onclick = () => app.router.navigate("organizer");
                mobileDash.style.display = "flex";
              } else {
                roleBtn.style.display = "none";
                mobileDash.style.display = "none";
              }
            }
          },
          updateMobileNav: (view) => {
            document
              .querySelectorAll(".mobile-nav-item")
              .forEach((el) => el.classList.remove("active"));
            if (view === "home")
              document
                .querySelectorAll(".mobile-nav-item")[0]
                .classList.add("active");
            if (view === "dashboard")
              document
                .getElementById("mobileTicketsBtn")
                .classList.add("active");
            if (view === "organizer")
              document.getElementById("mobileDashBtn").classList.add("active");
          },
          showToast: (msg, type = "success") => {
            const c = document.getElementById("toast-container");
            const t = document.createElement("div");
            t.className = `toast ${type}`;
            t.innerHTML = `<i class="ph ${type === "error" ? "ph-warning" : "ph-check"}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.classList.add("show"), 50);
            setTimeout(() => {
              t.classList.remove("show");
              setTimeout(() => t.remove(), 400);
            }, 3000);
          },
        },
      };
      document.addEventListener("DOMContentLoaded", app.init);
    </script>
  </body>
</html>
