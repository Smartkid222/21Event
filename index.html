<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>EventHub - Attendee Portal</title>
    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      /* -----------------------------------------------------------
           1. CSS VARIABLES & RESET
        ----------------------------------------------------------- */
      :root {
        /* Colors */
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --accent: #ec4899;
        --bg-dark: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --success: #10b981;
        --danger: #ef4444;

        /* Effects */
        --glass: blur(12px);
        --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 80px; /* Space for bottom nav on mobile */
        background-image:
          radial-gradient(
            circle at 10% 20%,
            rgba(99, 102, 241, 0.15) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(236, 72, 153, 0.15) 0%,
            transparent 40%
          );
      }

      /* -----------------------------------------------------------
           2. UTILITIES & COMPONENTS
        ----------------------------------------------------------- */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      button {
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s ease;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Animation for Price Update */
      @keyframes pricePop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
          color: var(--accent);
        }
        100% {
          transform: scale(1);
        }
      }
      .price-pop {
        animation: pricePop 0.2s ease-in-out;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--text-main);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .card {
        background: var(--bg-card);
        backdrop-filter: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-cat {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
      }
      .badge-sold {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      .badge-open {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* -----------------------------------------------------------
           3. LAYOUT STRUCTURE
        ----------------------------------------------------------- */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
        padding: 16px 0;
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        cursor: pointer;
      }

      .nav-actions {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .user-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        cursor: pointer;
      }

      /* -----------------------------------------------------------
           4. VIEWS
        ----------------------------------------------------------- */
      .view {
        display: none; /* Hidden by default */
        padding: 40px 0;
        animation: fadeIn 0.4s ease;
      }

      .view.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Landing View */
      .hero {
        text-align: center;
        padding: 60px 0;
      }

      .hero h1 {
        font-size: 2.5rem;
        line-height: 1.1;
        margin-bottom: 24px;
      }

      .hero p {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin-bottom: 30px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .search-bar {
        max-width: 500px;
        margin: 0 auto 40px auto;
        display: flex;
        gap: 10px;
      }

      .categories {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 40px;
      }

      .cat-chip {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 30px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
        font-size: 0.85rem;
      }

      .cat-chip:hover,
      .cat-chip.active {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
        color: white;
      }

      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
      }

      .event-card {
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
        cursor: pointer;
        border: 1px solid var(--border);
      }

      .event-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
      }

      .event-img {
        height: 180px;
        background-color: #333;
        background-size: cover;
        background-position: center;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .event-info h3 {
        margin-bottom: 8px;
        font-size: 1.2rem;
      }
      .event-meta {
        display: flex;
        gap: 12px;
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 16px;
      }
      .event-footer {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Event Details - NEW STYLES FOR MULTIPLE TICKETS */
      .detail-header {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
      }

      .detail-img {
        flex: 1;
        min-width: 300px;
        height: 350px;
        border-radius: 16px;
        background-size: cover;
        background-position: center;
      }

      .detail-content {
        flex: 1;
        min-width: 300px;
      }

      .ticket-list-container {
        margin-top: 24px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.2);
      }

      .ticket-item {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column; /* Mobile friendly stack */
        gap: 12px;
      }

      @media (min-width: 768px) {
        .ticket-item {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .ticket-item:last-child {
        border-bottom: none;
      }

      .ticket-info {
        flex: 1;
      }
      .ticket-name {
        font-weight: 600;
        font-size: 1.1rem;
      }
      .ticket-meta {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .qty-control {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px;
        border-radius: 8px;
      }

      .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
      }

      .qty-btn:hover:not(:disabled) {
        background: var(--primary);
      }

      .qty-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .qty-value {
        min-width: 24px;
        text-align: center;
        font-weight: 600;
      }

      /* Price Breakdown Styling */
      .price-breakdown {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        margin-top: 20px;
      }
      .price-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .price-row.fee {
        color: var(--accent);
        font-size: 0.85rem;
      }
      .price-row.total {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-main);
        margin-top: 8px;
        border-top: 1px dashed var(--border);
        padding-top: 8px;
      }

      /* Checkout Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--bg-dark);
      }

      /* Checkout Summary Styling */
      .checkout-summary {
        background: rgba(255, 255, 255, 0.03);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 24px;
      }
      .checkout-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .checkout-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed var(--border);
      }
      .checkout-total-price {
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
      }

      /* Toast Notifications */
      #toast-container {
        position: fixed;
        bottom: 90px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(10px);
        border-left: 4px solid var(--primary);
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* QR Code Simulation */
      .qr-placeholder {
        width: 150px;
        height: 150px;
        background-size: cover;
        margin: 0 auto;
        border-radius: 8px;
        border: 4px solid white;
        background-image: url("https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=EventHubTicket");
        transition: transform 0.3s;
      }
      .qr-placeholder:hover {
        transform: scale(1.05);
      }

      /* -----------------------------------------------------------
           5. MOBILE SPECIFIC STYLES (The "App" Look)
        ----------------------------------------------------------- */
      .mobile-bottom-nav {
        display: none; /* Hidden on Desktop */
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--border);
        z-index: 99;
        justify-content: space-around;
        align-items: center;
      }

      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 12px;
        transition: all 0.2s;
      }

      .mobile-nav-item i {
        font-size: 1.5rem;
        margin-bottom: 2px;
      }

      .mobile-nav-item.active {
        color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
      }

      .mobile-nav-item.highlight {
        color: var(--accent);
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 70px;
        }

        /* Hide standard header actions */
        .nav-actions {
          display: none;
        }

        /* Show Mobile Bottom Nav */
        .mobile-bottom-nav {
          display: flex;
        }

        /* Header adjustments */
        nav {
          justify-content: center;
        }
        header {
          padding: 10px 0;
        }

        .hero h1 {
          font-size: 2rem;
        }

        /* Cards: Full Width */
        .events-grid {
          grid-template-columns: 1fr;
          gap: 16px;
          padding-bottom: 0;
        }

        .event-card {
          border-radius: 16px;
        }

        .event-img {
          height: 200px;
          border-radius: 12px;
        }

        /* Modals: Bottom Sheet Style (Slide Up) */
        .modal-overlay {
          justify-content: flex-end;
          align-items: center;
          background: transparent;
        }

        .modal {
          width: 100%;
          max-width: 100%;
          border-radius: 24px 24px 0 0;
          padding-bottom: 30px;
          transform: translateY(100%);
          transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
          max-height: 90vh;
          border-top: 1px solid var(--border);
        }

        .modal-overlay.open .modal {
          transform: translateY(0);
        }

        .btn {
          padding: 14px 24px;
          font-size: 1rem;
        }

        /* Toast Position */
        #toast-container {
          bottom: 80px;
          right: 50%;
          transform: translateX(50%);
          width: 90%;
          align-items: center;
        }
        .toast {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <nav>
          <div class="logo" onclick="app.router.navigate('home')">
            <i class="ph ph-ticket"></i> EventHub
          </div>
          <!-- Standard Desktop Nav -->
          <div class="nav-actions">
            <button
              class="btn btn-secondary"
              onclick="app.router.navigate('home')"
            >
              Find Events
            </button>
            <div id="loggedOutNav" style="display: flex; gap: 10px">
              <div class="user-toggle" onclick="app.ui.openModal('authModal')">
                <i class="ph ph-user-circle" id="roleIcon"></i>
                <span id="roleLabel">Login</span>
              </div>
            </div>
            <div
              id="loggedInNav"
              style="display: none; gap: 10px; align-items: center"
            >
              <span id="userNameDisplay" style="font-weight: 500"></span>
              <button
                class="btn btn-secondary"
                onclick="app.router.navigate('dashboard')"
              >
                My Tickets
              </button>
              <button id="orgActionBtn" class="btn btn-primary">
                Become Organizer
              </button>
              <button
                class="btn btn-secondary"
                style="padding: 8px"
                onclick="app.auth.logout()"
                title="Logout"
              >
                <i class="ph ph-sign-out"></i>
              </button>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- MOBILE BOTTOM NAV (Visible only on screens < 768px) -->
    <div class="mobile-bottom-nav">
      <div class="mobile-nav-item active" onclick="app.router.navigate('home')">
        <i class="ph ph-house"></i>
        <span>Home</span>
      </div>
      <div class="mobile-nav-item" onclick="app.router.navigate('dashboard')">
        <i class="ph ph-ticket"></i>
        <span>Tickets</span>
      </div>
      <div class="mobile-nav-item highlight" id="mobileOrgBtn">
        <i class="ph ph-plus-circle"></i>
        <span id="mobileOrgText">Organize</span>
      </div>
      <div
        class="mobile-nav-item"
        id="mobileLoginBtn"
        onclick="app.ui.openModal('authModal')"
      >
        <i class="ph ph-user"></i>
        <span>Profile</span>
      </div>
    </div>

    <main id="app" class="container"></main>
    <div id="toast-container"></div>

    <!-- Modals -->
    <!-- 1. Auth Modal -->
    <div class="modal-overlay" id="authModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 id="authTitle">Login</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('authModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form id="authForm" onsubmit="app.auth.handleAuth(event)">
          <div class="form-group">
            <label>Email</label
            ><input
              type="email"
              name="email"
              required
              placeholder="user@example.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label
            ><input
              type="password"
              name="password"
              required
              placeholder="••••"
            />
          </div>
          <div id="signupFields" style="display: none">
            <div class="form-group">
              <label>Full Name</label
              ><input type="text" name="name" placeholder="John Doe" />
            </div>
          </div>
          <div
            style="
              display: flex;
              gap: 10px;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <input type="checkbox" id="rememberMe" style="width: auto" />
            <label for="rememberMe" style="margin: 0; font-size: 0.85rem"
              >Remember me</label
            >
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center"
          >
            Submit
          </button>
        </form>
        <p
          style="
            text-align: center;
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
          "
        >
          <span id="authSwitchText">New here?</span>
          <a
            href="#"
            style="color: var(--primary)"
            onclick="app.ui.toggleAuthMode()"
            >Click here</a
          >
        </p>
      </div>
    </div>

    <!-- 2. Organizer Registration Modal -->
    <div class="modal-overlay" id="organizerModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Become an Organizer</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('organizerModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form onsubmit="app.auth.becomeOrganizer(event)">
          <div class="form-group">
            <label>Company / Organizer Name</label
            ><input type="text" name="orgName" required />
          </div>
          <div class="form-group">
            <label style="font-size: 0.8rem"
              >By registering, you agree to shift your role to Organizer. You
              will be redirected.</label
            >
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center"
          >
            Register & Go to Dashboard
          </button>
        </form>
      </div>
    </div>

    <!-- 3. Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Checkout</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('checkoutModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div id="checkoutSummary" class="checkout-summary"></div>
        <form onsubmit="app.handlers.processPayment(event)">
          <div class="form-group">
            <label>Cardholder Name</label
            ><input type="text" required placeholder="John Doe" />
          </div>
          <div class="form-group">
            <label>Card Number</label
            ><input
              type="text"
              required
              placeholder="0000 0000 0000 0000"
              maxlength="19"
            />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px">
            <div class="form-group">
              <label>Expiry</label
              ><input type="text" required placeholder="MM/YY" maxlength="5" />
            </div>
            <div class="form-group">
              <label>CVC</label
              ><input type="text" required placeholder="123" maxlength="3" />
            </div>
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="
              width: 100%;
              justify-content: center;
              font-size: 1.1rem;
              padding: 16px;
            "
          >
            Pay <span id="payAmount"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- 4. Ticket Detail Modal (New) -->
    <div class="modal-overlay" id="ticketDetailModal">
      <div class="card modal" style="text-align: center">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2>My Ticket</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('ticketDetailModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>

        <!-- Larger QR Code -->
        <div
          id="modalQr"
          class="qr-placeholder"
          style="width: 200px; height: 200px; margin: 0 auto 20px auto"
        ></div>

        <h3 id="modalEventName" style="margin-bottom: 5px"></h3>
        <span
          id="modalTicketType"
          class="badge badge-cat"
          style="margin-bottom: 15px; display: inline-block"
        ></span>
        <p
          id="modalEventDate"
          style="color: var(--text-muted); margin-bottom: 20px"
        ></p>

        <button
          class="btn btn-primary"
          onclick="app.ui.simulateScan()"
          style="width: 100%; justify-content: center"
        >
          <i class="ph ph-qr-code"></i> Simulate Scan
        </button>
        <button
          class="btn btn-secondary"
          onclick="app.ui.closeModal('ticketDetailModal')"
          style="margin-top: 10px; width: 100%; justify-content: center"
        >
          Close
        </button>
      </div>
    </div>

    <script>
      const app = {
        state: {
          isLoginMode: true,
          pendingEventId: null,
          cart: {}, // Stores { ticketIndex: quantity }
          feePercentage: 0.05, // 5% Service Fee
          currentEventId: null,
        },

        init: () => {
          if (!localStorage.getItem("eh_events")) {
            const seedEvents = [
              {
                id: "evt_101",
                title: "Neon Music Festival",
                date: "2023-11-15",
                location: "Los Angeles",
                category: "Music",
                // Legacy structure for backward compat test
                price: 150,
                totalTickets: 500,
                sold: 342,
                organizerId: "demo_org",
                image: "https://picsum.photos/seed/music/400/300",
              },
              {
                id: "evt_102",
                title: "AI Future Summit",
                date: "2023-12-05",
                location: "San Francisco",
                category: "Tech",
                // New Multi-ticket structure
                tickets: [
                  { type: "Early Bird", price: 199, qty: 50, sold: 50 },
                  { type: "Regular", price: 299, qty: 100, sold: 10 },
                  { type: "VIP Access", price: 499, qty: 20, sold: 5 },
                ],
                organizerId: "demo_org",
                image: "https://picsum.photos/seed/tech/400/300",
              },
            ];
            localStorage.setItem("eh_events", JSON.stringify(seedEvents));
            localStorage.setItem("eh_users", JSON.stringify([]));
            localStorage.setItem("eh_tickets", JSON.stringify([]));
          }
          app.ui.checkSession();
          app.router.navigate("home");
        },

        save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        get: (key) => JSON.parse(localStorage.getItem(key) || "[]"),

        // Helper to Normalize Event Data (Backward Compatibility)
        normalizeEvent: (event) => {
          // If event doesn't have the new 'tickets' array, create it from legacy properties
          if (!event.tickets || event.tickets.length === 0) {
            event.tickets = [
              {
                type: "General Admission",
                price: event.price || 0,
                qty: event.totalTickets || 0,
                sold: event.sold || 0,
              },
            ];
          }
          return event;
        },

        calculateTotal: (event) => {
          const tickets = event.tickets;
          let subtotal = 0;
          let itemCount = 0;

          tickets.forEach((t, index) => {
            const qty = app.state.cart[index] || 0;
            subtotal += qty * t.price;
            itemCount += qty;
          });

          const fee = subtotal * app.state.feePercentage;
          const total = subtotal + fee;

          return {
            subtotal: subtotal.toFixed(2),
            fee: fee.toFixed(2),
            total: total.toFixed(2),
            itemCount,
          };
        },

        router: {
          navigate: (viewName, params = null) => {
            const main = document.getElementById("app");
            app.router.current = viewName;
            if (viewName === "home") app.views.renderHome(main, params);
            if (viewName === "dashboard") app.views.renderMyTickets(main);
            if (viewName === "event") app.views.renderEventDetail(main, params);
            window.scrollTo(0, 0);
            app.ui.updateMobileNav(viewName);
          },
        },

        views: {
          renderHome: (container, query) => {
            const events = app
              .get("eh_events")
              .filter(
                (e) =>
                  !query || e.title.toLowerCase().includes(query.toLowerCase()),
              )
              .map((e) => {
                // Normalize to check availability
                const normE = app.normalizeEvent(e);
                const totalQty = normE.tickets.reduce(
                  (acc, t) => acc + t.qty,
                  0,
                );
                const totalSold = normE.tickets.reduce(
                  (acc, t) => acc + t.sold,
                  0,
                );
                const isSoldOut = totalSold >= totalQty;

                // Display lowest price if multiple
                const minPrice = Math.min(...normE.tickets.map((t) => t.price));

                return `
                        <div class="card event-card" onclick="${isSoldOut ? "" : `app.router.navigate('event', '${e.id}')`}">
                            <div class="event-img" style="background-image: url('${e.image}')"></div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span class="badge badge-cat">${e.category}</span>
                                ${isSoldOut ? '<span class="badge badge-sold">Sold Out</span>' : '<span class="badge badge-open">Available</span>'}
                            </div>
                            <h3>${e.title}</h3>
                            <div style="color:var(--text-muted); font-size:0.9rem; margin-bottom:16px;">
                                <i class="ph ph-calendar-blank"></i> ${new Date(e.date).toLocaleDateString()} &bull; ${e.location}
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto;">
                                <span style="font-weight:700;">${minPrice > 0 ? "$" + minPrice : "Free"}</span>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">${isSoldOut ? "Waitlist" : "Buy Ticket"}</button>
                            </div>
                        </div>`;
              })
              .join("");
            container.innerHTML = `
                        <div class="view active">
                          <section class="hero">
                                <span class="badge badge-cat" style="margin-bottom:16px; display:inline-block;">#1 Event Platform</span>
                                <h1>Create, Promote & Sell<br>Your Events</h1>
                                <p>The all-in-one platform for organizers and attendees. Discover local experiences or host your own.</p>
                                <div style="display:flex; gap:16px; justify-content:center;">
                                    <button class="btn btn-primary" onclick="document.getElementById('globalSearch').focus()">Find Events</button>
                                </div>
                            </section>
                        <div class="events-grid">${events}</div>
                        </div>
                    `;
          },

          renderEventDetail: (container, eventId) => {
            let event = app.get("eh_events").find((e) => e.id === eventId);
            if (!event) return app.router.navigate("home");

            // IMPORTANT: Normalize data structure
            event = app.normalizeEvent(event);
            app.state.currentEventId = eventId;

            // Reset Cart
            app.state.cart = {};
            event.tickets.forEach((_, idx) => (app.state.cart[idx] = 0));

            // Calculate availability
            const totalTickets = event.tickets.reduce(
              (acc, t) => acc + t.qty,
              0,
            );
            const totalSold = event.tickets.reduce((acc, t) => acc + t.sold, 0);
            const isSoldOut = totalSold >= totalTickets;

            container.innerHTML = `
                        <div class="view active">
                          <button class="btn btn-secondary" onclick="app.router.navigate('home')" style="margin-bottom:20px;"><i class="ph ph-arrow-left"></i> Back</button>
                          <div class="detail-header">
                            <div class="detail-img" style="background-image:url('${event.image}');"></div>
                            <div class="detail-content">
                              <h1 style="margin-bottom:12px; line-height:1.2;">${event.title}</h1>
                              <div style="display:flex; flex-direction:column; gap:8px; color:var(--text-muted); margin-bottom:24px;">
                                <span><i class="ph ph-calendar-blank"></i> ${new Date(event.date).toDateString()} at 7:00 PM</span>
                                <span><i class="ph ph-map-pin"></i> ${event.location}</span>
                                <span><i class="ph ph-users"></i> ${totalTickets - totalSold} spots left</span>
                              </div>
                              <p style="line-height:1.6; color:#cbd5e1;">Join us for an incredible experience! Select your ticket type below.</p>
                              
                              ${
                                !isSoldOut
                                  ? `
                                <div class="ticket-list-container" id="ticketList">
                                    ${event.tickets
                                      .map((ticket, index) => {
                                        const remaining =
                                          ticket.qty - ticket.sold;
                                        const isTypeSoldOut = remaining <= 0;
                                        return `
                                        <div class="ticket-item">
                                            <div class="ticket-info">
                                                <div class="ticket-name">${ticket.type} ${isTypeSoldOut ? '<span style="color:var(--danger); font-size:0.8rem; margin-left:8px;">(Sold Out)</span>' : ""}</div>
                                                <div class="ticket-meta">$${ticket.price} • ${remaining} left</div>
                                            </div>
                                            ${
                                              !isTypeSoldOut
                                                ? `
                                            <div class="qty-control">
                                                <button class="qty-btn" onclick="app.handlers.updateTicketQty(${index}, -1)">-</button>
                                                <span class="qty-value" id="qty-${index}">0</span>
                                                <button class="qty-btn" onclick="app.handlers.updateTicketQty(${index}, 1)">+</button>
                                            </div>
                                            `
                                                : `<button class="btn btn-secondary" style="opacity:0.5; cursor:default;" disabled>Sold Out</button>`
                                            }
                                        </div>
                                        `;
                                      })
                                      .join("")}
                                </div>
                                
                                <div class="price-breakdown">
                                    <div class="price-row" id="breakdownItems"></div>
                                    <div class="price-row fee"><span>Service Fee (${app.state.feePercentage * 100}%)</span><span id="feeDisplay">$0.00</span></div>
                                    <div class="price-row total"><span>Total</span><span id="totalDisplay">$0.00</span></div>
                                </div>
                                
                                <button id="buyBtn" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:20px; padding:16px;" disabled onclick="app.handlers.initBuy()">
                                    Select Tickets
                                </button>
                              `
                                  : `<div style="margin-top:20px; color:var(--danger); font-weight:bold;">Sold Out</div>`
                              }
                            </div>
                          </div>
                        </div>
                    `;
            app.handlers.updateSummary();
          },

          renderMyTickets: (container) => {
            const user = JSON.parse(localStorage.getItem("eh_session"));
            if (!user) {
              app.ui.openModal("authModal");
              return;
            }

            // Get all tickets for this user (now they are individual records)
            const myTickets = app
              .get("eh_tickets")
              .filter((t) => t.userId === user.id);

            if (myTickets.length === 0) {
              container.innerHTML = `
                <div class="view active" style="text-align:center; padding-top:60px;">
                  <i class="ph ph-ticket" style="font-size: 4rem; color: var(--text-muted); margin-bottom:20px;"></i>
                  <h2>No Tickets Yet!</h2>
                  <p style="color:var(--text-muted); margin-bottom:20px;">Explore events and grab your first ticket!</p>
                  <button class="btn btn-primary" onclick="app.router.navigate('home')">Browse Events</button>
                </div>`;
              return;
            }

            // Render a card for EACH ticket - NOW CLICKABLE
            container.innerHTML = `
              <h1>My Tickets (${myTickets.length})</h1>
              <div class="events-grid" style="margin-top:20px;">
                ${myTickets
                  .map((t) => {
                    // Find event details for this ticket
                    const evt = app
                      .get("eh_events")
                      .find((e) => e.id === t.eventId);
                    const eventName = evt ? evt.title : "Unknown Event";
                    const eventDate = evt
                      ? new Date(evt.date).toLocaleDateString()
                      : "";
                    const eventImg = evt ? evt.image : "";

                    // Generate unique QR for this specific ticket
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${t.qrData}`;

                    return `
                      <!-- Wrapper div to make the whole card clickable -->
                      <div class="card" style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:16px; cursor:pointer; transition: transform 0.2s;" onclick="app.ui.openTicketModal('${t.id}')">
                        
                        <!-- Small Event Header -->
                        <div style="width:100%; text-align:left; padding-bottom:12px; border-bottom:1px solid var(--border);">
                           <h3 style="font-size:1.1rem; margin-bottom:4px;">${eventName}</h3>
                           <div style="color:var(--text-muted); font-size:0.85rem;">
                              <i class="ph ph-calendar"></i> ${eventDate}
                           </div>
                        </div>

                        <!-- Ticket Type Badge -->
                        <span class="badge badge-cat" style="font-size:1rem; padding:8px 16px;">
                           ${t.ticketType}
                        </span>

                        <!-- Unique QR Code -->
                        <div class="qr-placeholder" style="background-image: url('${qrUrl}'); margin:0;"></div>
                        
                        <p style="font-size:0.75rem; color:var(--text-muted); margin-top:auto;">
                           Click to view
                        </p>
                      </div>`;
                  })
                  .join("")}
              </div>
            `;
          },
        },

        handlers: {
          // Update specific ticket quantity in cart
          updateTicketQty: (index, change) => {
            // 1. Get the event from storage
            const events = app.get("eh_events");
            let event = events.find((e) => e.id === app.state.currentEventId);

            // 2. CRITICAL FIX: Normalize the event so it has a 'tickets' array
            // This converts legacy {price: 100} into {tickets: [{type: 'General', price: 100}]}
            event = app.normalizeEvent(event);

            const currentQty = app.state.cart[index] || 0;
            const newQty = currentQty + change;

            // Get limit from the normalized ticket data
            const ticketType = event.tickets[index];
            const remaining = ticketType.qty - ticketType.sold;

            if (newQty >= 0 && newQty <= remaining) {
              app.state.cart[index] = newQty;

              // Update UI Number
              const qtyEl = document.getElementById(`qty-${index}`);
              if (qtyEl) qtyEl.innerText = newQty;

              app.handlers.updateSummary();
            }
          },

          // Update Total Price and Button Text
          updateSummary: () => {
            const events = app.get("eh_events");
            let event = events.find((e) => e.id === app.state.currentEventId);

            // Normalize to ensure we can calculate totals
            event = app.normalizeEvent(event);

            const calc = app.calculateTotal(event);
            const btn = document.getElementById("buyBtn");

            // Render breakdown text
            let breakdownHTML = "";
            let hasItems = false;

            event.tickets.forEach((t, idx) => {
              const q = app.state.cart[idx] || 0;
              if (q > 0) {
                hasItems = true;
                breakdownHTML += `<div class="price-row"><span>${t.type} (x${q})</span><span>$${(t.price * q).toFixed(2)}</span></div>`;
              }
            });

            const breakdownEl = document.getElementById("breakdownItems");
            if (breakdownEl) breakdownEl.innerHTML = breakdownHTML;

            // Update Fees and Total
            const feeEl = document.getElementById("feeDisplay");
            const totalEl = document.getElementById("totalDisplay");

            if (feeEl) feeEl.innerText = `$${calc.fee}`;
            if (totalEl) {
              totalEl.innerText = `$${calc.total}`;
              // Pop animation
              totalEl.classList.remove("price-pop");
              void totalEl.offsetWidth;
              if (hasItems) totalEl.classList.add("price-pop");
            }

            // Update Button State
            if (btn) {
              if (hasItems) {
                btn.disabled = false;
                btn.innerText = `Buy Ticket - $${calc.total}`;
              } else {
                btn.disabled = true;
                btn.innerText = "Select Tickets";
              }
            }
          },

          initBuy: () => {
            if (!localStorage.getItem("eh_session")) {
              app.ui.showToast("Please login to purchase tickets", "info");
              app.ui.openModal("authModal");
              return;
            }
            app.ui.renderCheckoutSummary();
            app.ui.openModal("checkoutModal");
          },

          processPayment: (e) => {
            e.preventDefault();
            const btn = e.target.querySelector("button");
            btn.innerHTML = "Processing...";

            setTimeout(() => {
              const user = JSON.parse(localStorage.getItem("eh_session"));
              const events = app.get("eh_events");
              let evtIdx = events.findIndex(
                (e) => e.id === app.state.currentEventId,
              );
              let event = events[evtIdx];

              // Normalize event data (Handles both legacy single tickets and new multi-tickets)
              event = app.normalizeEvent(event);

              let totalQty = 0;

              // 1. Update Event Inventory (Sold Counts)
              event.tickets.forEach((t, idx) => {
                const qty = app.state.cart[idx] || 0;
                if (qty > 0) {
                  t.sold += qty;
                  totalQty += qty;
                }
              });

              // Save updated event back to storage
              events[evtIdx] = event;
              app.save("eh_events", events);

              // 2. Create INDIVIDUAL Ticket Records for the User
              const userTickets = app.get("eh_tickets");

              // Loop through each ticket type in the cart
              event.tickets.forEach((t, idx) => {
                const qty = app.state.cart[idx] || 0;

                // Loop 'qty' times to create that many unique tickets
                for (let i = 0; i < qty; i++) {
                  const uniqueId =
                    "TIX-" +
                    Date.now() +
                    "-" +
                    Math.floor(Math.random() * 10000) +
                    "-" +
                    i;

                  userTickets.push({
                    id: uniqueId, // Unique ID for this specific physical/digital ticket
                    userId: user.id,
                    eventId: app.state.currentEventId,
                    ticketType: t.type, // e.g. "VIP Access"
                    purchaseDate: new Date(),
                    qrData: uniqueId, // The QR code data is unique to this ticket
                  });
                }
              });

              app.save("eh_tickets", userTickets);

              app.ui.closeModal("checkoutModal");
              app.ui.showToast(
                `Payment Successful! ${totalQty} Ticket(s) Issued.`,
              );
              app.router.navigate("dashboard");
              btn.innerHTML = "Pay";
            }, 1500);
          },
        },

        auth: {
          handleAuth: (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const users = app.get("eh_users");
            if (app.state.isLoginMode) {
              const user = users.find(
                (u) =>
                  u.email === fd.get("email") &&
                  u.password === fd.get("password"),
              );
              if (user) {
                localStorage.setItem("eh_session", JSON.stringify(user));
                app.ui.closeModal("authModal");
                app.ui.checkSession();
                app.ui.showToast(`Welcome back, ${user.name}`);
              } else {
                app.ui.showToast("Invalid credentials", "error");
              }
            } else {
              if (users.find((u) => u.email === fd.get("email"))) {
                app.ui.showToast("Email already exists", "error");
                return;
              }
              const newUser = {
                id: "u_" + Date.now(),
                name: fd.get("name"),
                email: fd.get("email"),
                password: fd.get("password"),
                role: "attendee",
              };
              users.push(newUser);
              app.save("eh_users", users);
              localStorage.setItem("eh_session", JSON.stringify(newUser));
              app.ui.closeModal("authModal");
              app.ui.checkSession();
              app.ui.showToast("Account created!");
            }
          },
          logout: () => {
            localStorage.removeItem("eh_session");
            window.location.reload();
          },
          becomeOrganizer: (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem("eh_session"));
            const users = app.get("eh_users");
            const idx = users.findIndex((u) => u.id === user.id);
            user.role = "organizer";
            user.organizerName = new FormData(e.target).get("orgName");
            users[idx] = user;
            app.save("eh_users", users);
            localStorage.setItem("eh_session", JSON.stringify(user));
            window.location.href = "organizer.html";
          },
        },

        ui: {
          updateMobileNav: (viewName) => {
            const items = document.querySelectorAll(".mobile-nav-item");
            items.forEach((i) => i.classList.remove("active"));
            if (viewName === "home") items[0].classList.add("active");
            if (viewName === "dashboard") items[1].classList.add("active");
          },
          renderCheckoutSummary: () => {
            const events = app.get("eh_events");
            let event = events.find((e) => e.id === app.state.currentEventId);

            // FIX: Normalize event so we can loop through tickets
            event = app.normalizeEvent(event);

            const calc = app.calculateTotal(event);

            let itemsHtml = "";
            event.tickets.forEach((t, idx) => {
              const q = app.state.cart[idx] || 0;
              if (q > 0) {
                itemsHtml += `
                    <div class="checkout-item">
                        <span>${t.type} <span style="color:var(--text-muted)">x${q}</span></span>
                        <span>$${(t.price * q).toFixed(2)}</span>
                    </div>`;
              }
            });

            const summaryHTML = `
                ${itemsHtml}
                <div class="checkout-row" style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:1px dashed var(--border);">
                    <span>Subtotal</span><span>$${calc.subtotal}</span>
                </div>
                <div class="checkout-row fee">
                    <span>Service Fee (${app.state.feePercentage * 100}%)</span><span>$${calc.fee}</span>
                </div>
                <div class="checkout-total">
                    <span style="font-weight:600;">Total to Pay</span>
                    <span class="checkout-total-price" id="checkoutTotalPriceDisplay">$${calc.total}</span>
                </div>
            `;
            document.getElementById("checkoutSummary").innerHTML = summaryHTML;
            document.getElementById("payAmount").innerText = `$${calc.total}`;

            // Pop Animation for total
            const priceEl = document.getElementById(
              "checkoutTotalPriceDisplay",
            );
            priceEl.classList.remove("price-pop");
            void priceEl.offsetWidth;
            priceEl.classList.add("price-pop");
          },

          // New Function: Open Ticket Detail Modal
          openTicketModal: (ticketId) => {
            const ticket = app.get("eh_tickets").find((t) => t.id === ticketId);
            if (!ticket) return;

            const evt = app
              .get("eh_events")
              .find((e) => e.id === ticket.eventId);
            const eventName = evt ? evt.title : "Unknown Event";
            const eventDate = evt
              ? new Date(evt.date).toLocaleDateString()
              : "";

            document.getElementById("modalEventName").innerText = eventName;
            document.getElementById("modalEventDate").innerText = eventDate;
            document.getElementById("modalTicketType").innerText =
              ticket.ticketType;

            // Generate larger QR
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${ticket.qrData}`;
            document.getElementById("modalQr").style.backgroundImage =
              `url('${qrUrl}')`;

            app.ui.openModal("ticketDetailModal");
          },

          // New Function: Simulate Scan
          simulateScan: () => {
            app.ui.showToast("Scanning Ticket...", "info");
            setTimeout(() => {
              app.ui.showToast("Ticket Valid! Check-In Successful.", "success");
            }, 1000);
          },

          // ... keep the rest of ui object (checkSession, openModal, closeModal, etc.) exactly as is ...
          checkSession: () => {
            const user = JSON.parse(localStorage.getItem("eh_session"));
            // Desktop Nav
            if (user) {
              document.getElementById("loggedOutNav").style.display = "none";
              document.getElementById("loggedInNav").style.display = "flex";
              document.getElementById("userNameDisplay").innerText = user.name;
              const orgBtn = document.getElementById("orgActionBtn");
              if (user.role === "organizer") {
                orgBtn.innerText = "Organizer Dashboard";
                orgBtn.onclick = () =>
                  (window.location.href = "organizer.html");
                orgBtn.style.background = "var(--primary-dark)";
              } else {
                orgBtn.innerText = "Become Organizer";
                orgBtn.onclick = () => app.ui.openModal("organizerModal");
                orgBtn.style.background = "";
              }
            } else {
              document.getElementById("loggedOutNav").style.display = "flex";
              document.getElementById("loggedInNav").style.display = "none";
            }
            // Mobile Nav Adjustments
            const mobileOrgBtn = document.getElementById("mobileOrgBtn");
            const mobileLoginBtn = document.getElementById("mobileLoginBtn");
            if (user) {
              mobileLoginBtn.onclick = app.auth.logout;
              mobileLoginBtn.querySelector("span").innerText = "Logout";
              mobileLoginBtn.querySelector("i").className = "ph ph-sign-out";
              if (user.role === "organizer") {
                mobileOrgBtn.onclick = () =>
                  (window.location.href = "organizer.html");
                document.getElementById("mobileOrgText").innerText =
                  "Dashboard";
              }
            } else {
              mobileLoginBtn.onclick = () => app.ui.openModal("authModal");
              mobileLoginBtn.querySelector("span").innerText = "Profile";
              mobileLoginBtn.querySelector("i").className = "ph ph-user";
            }
          },
          openModal: (id) => document.getElementById(id).classList.add("open"),
          closeModal: (id) =>
            document.getElementById(id).classList.remove("open"),
          toggleAuthMode: () => {
            app.state.isLoginMode = !app.state.isLoginMode;
            document.getElementById("authTitle").innerText = app.state
              .isLoginMode
              ? "Login"
              : "Sign Up";
            document.getElementById("authSwitchText").innerText = app.state
              .isLoginMode
              ? "New here?"
              : "Already have an account?";
            document.getElementById("signupFields").style.display = app.state
              .isLoginMode
              ? "none"
              : "block";
            document.querySelector("#authForm button").innerText = app.state
              .isLoginMode
              ? "Login"
              : "Sign Up";
          },
          showToast: (msg, type = "success") => {
            const c = document.getElementById("toast-container");
            const t = document.createElement("div");
            t.className = "toast";
            t.style.borderLeftColor =
              type === "error" ? "var(--danger)" : "var(--primary)";
            t.innerHTML = `<i class="ph ${type === "error" ? "ph-warning" : "ph-check"}"></i> ${msg}`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
          },
        },
        utils: { searchEvents: (q) => app.router.navigate("home", q) },
      };
      document.addEventListener("DOMContentLoaded", app.init);
    </script>
  </body>
</html>
